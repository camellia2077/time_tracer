## [v0.2.0] - 2026-02-17

### 新增功能 (Added)


* **支持 TOML 配置文件导出（目录直出）**：不再打包为 `.zip`，改为导出为可直接浏览和覆盖的 TOML 目录结构（含 `meta/`、`converter/`、`reports/markdown/`）。
* **支持 TXT 导出**：在 `TXT` 页面支持导出当前月份 TXT，并支持导出全部月份 TXT；导出文件名统一为 `YYYY-MM.txt`。
* **全部 TXT 导出目录优化**：导出全部月份时固定写入 `dates/YYYY/` 目录结构；年份来自 TXT 第一行 `yYYYY`（不依赖文件名），并覆盖同名文件。
* **TXT 导出编码兼容**：导出 TXT 统一按 UTF-8 写出并附带 BOM，避免在部分查看器中出现中文乱码。

### UI 改进 (UI Improvements)

* **Record Page 交互优化**：将 Quick Access 区域重构为 `ElevatedCard` 容器，使用标准的 Expand/Collapse 箭头替代原有的齿轮图标，并支持点击标题栏展开/折叠设置项，提升交互一致性。
* **UI 风格统一**：统一 Record 与 Report 页面的卡片视觉风格，所有主要功能卡片（Time, Input, Quick Access, Report Params）均应用 `MaterialTheme.shapes.extraLarge` 圆角标准。
* **Txt Editor 布局调整**：将文件选择（Month Navigation）卡片移动至屏幕底部，优化单手操作体验。
* **震动反馈**：为 `Record Activity` 按钮添加长按震动反馈，提升操作确认感。
* **底部间距修正**：修复 Report 等滚动页面底部内容被导航栏遮挡的问题，适配 Edge-to-Edge 显示。
* **新增主题色**：
    * **可爱/少女**：Coral (珊瑚粉)、Periwinkle (长春花蓝)、Mocha (摩卡熊)
    * **科技/极客**：Lime (极客绿)、Electric (电光蓝)、Graphite (石墨灰)
    * **经典/自然**：Crimson (绯红)、Sage (鼠尾草绿)、Navy (海军蓝)、Canary (金丝雀黄)
    * **梦幻/紫粉**：Orchid (兰花紫)、Cerise (樱桃红)、Lilac (丁香紫)、Amethyst (紫水晶)
    * **复古/怀旧**：Olive (橄榄绿)、Maroon (栗红/褐红)、Denim (丹宁蓝)、Mustard (芥末黄)
    * **自然/元素**：Forest (森林绿)、Storm (风暴灰)、Turquoise (松石绿)、Rust (铁锈红)
* **主题色排序优化**：将所有主题色按色相（彩虹色顺：红橙黄绿青蓝紫+中性色）重新排序，提升选择时的视觉体验。
* **版本信息更新**：更新 Android 核心库版本为 `v0.6.2`，Android App 本版本号修正为 `v0.2.0`。

### 技术改进/重构 (Changed/Refactor)

* **Core processed JSON 能力按平台裁剪**：在 `apps/time_tracer/CMakeLists.txt` 新增 `TT_ENABLE_PROCESSED_JSON_IO` 开关（默认 `ON`），并在 `ANDROID` 下强制 `OFF`，实现 Windows 保留、Android 关闭。
* **Android 编译链路去 JSON 实体化**：在 `apps/time_tracer/cmake/sources/infrastructure_io_sources.cmake` 中按开关切换源码；Android 不再编译 `processed_data_io.cpp`、`json_serializer.cpp`、`log_codec.cpp`，改为 no-op 的 `processed_data_io_noop.cpp`。
* **I/O 依赖最小化**：`time_tracker_io_adapters` 仅在 `TT_ENABLE_PROCESSED_JSON_IO=ON` 时链接 `nlohmann_json::nlohmann_json`；Android 关闭 processed JSON I/O 后不再为该链路引入 JSON 序列化依赖。
* **Android 运行时策略显式化**：`NativeRuntimeController` 与 `IngestSyncUseCase` 保持 `saveProcessedOutput = false`，并补充注释说明其与 core feature flag 对齐，避免未来误开启。
* **协议兼容性保持不变**：本次仅裁剪“processed 文件落盘/回读”的 JSON 实体化链路，不修改 JNI 响应 JSON 协议与 Kotlin 解析流程。
* **TXT 存储源视图统一**：`TextStorage` 继续统一暴露 `full/`、`smoke/`、`live_raw/` 三类来源，并新增 source/path 解析能力，确保编辑与写回始终基于同一条源路径。
* **Record 与导入 TXT 对齐**：`recordNow` 不再固定写入 `live_raw`；改为优先写入当前已选 TXT 所在 source（`full`/`smoke`/`live_raw`），并对同一 source 执行 ingest，同步避免“导入”和“记录”分裂。

* 重构 **QueryReportScreen**：将 `apps/tracer_android/feature-report/src/main/java/com/example/tracer/ui/screen/QueryReportScreen.kt` 拆分为 `ReportCard`、`StatsCard`、`TreeCard`、`SegmentedInputs`，保持原有交互与输出不变。
* 重构 **QueryReportViewModel**：将 `apps/tracer_android/feature-report/src/main/java/com/example/tracer/ui/viewmodel/QueryReportViewModel.kt` 拆分为“报表触发”“分析触发”“参数校验”三层，保持状态字段与对外接口不变。
* 重构 **TracerScreen**：将 `apps/tracer_android/app/src/main/java/com/example/tracer/ui/screen/TracerScreen.kt` 拆分为“底部导航壳”“Tab 路由层”“结果展示层”，保持页面路由与状态展示不变。
* 重构 **ConfigScreen**：将 `apps/tracer_android/app/src/main/java/com/example/tracer/ui/screen/ConfigScreen.kt` 拆分为“分类切换”“文件列表”“编辑器”“主题设置”四块，保持配置编辑流程不变。
* 重构 **NativeRuntimeController**：将 `apps/tracer_android/runtime/src/main/java/com/example/tracer/runtime/NativeRuntimeController.kt` 按 `init / ingest / query / report / record / storage` 六块进行职责收敛，保持 `RuntimeGateway` 行为与返回结构不变。
* 重构 **LiveRawRecordStore**：将 `apps/tracer_android/runtime/src/main/java/com/example/tracer/runtime/LiveRawRecordStore.kt` 拆分为“输入规范化”“记录解析”“落盘写入”三块，保持 TXT 写入结果与错误语义不变。
* 同步重构验证流程：每次改动后执行 `python .\scripts\run.py build --app tracer_android --profile android_style *>&1 | Tee-Object .\scripts\docs\android-check.log`，确认编译通过且 `lintDebug` 不新增告警。

### 补充更新（2026-02-19）

* **TXT 月份解析升级**：`RecordUseCases` 解析优先级调整为 `yYYYY + mMM` > `yYYYY + 首个 MMDD` > 文件名，空月文件（仅 `y+m`）可正确定位到目标月份。
* **新建月文件头升级**：`LiveRawRecordStore` 新建月文件时默认写入两行头：`yYYYY`、`mMM`，与 Windows 侧结构校验规则对齐。
* **Android suite 守卫补充**：`test/suites/tracer_android/tests/commands_base_config.toml` 增加 `mMM` 解析与写入检查，防止后续回退。
* **新增语言切换功能（中文/英文/日语）**：在 `Config` 页面新增语言选项，支持 `中文`、`English`、`日本語` 三语切换。
* **语言设置持久化与启动生效**：语言偏好写入用户配置并在应用启动时应用；`Locale` 映射扩展为 `zh / en / ja`，切换后主要页面可见文案按目标语言即时展示。
* **主要页面文案资源化迁移**：`Data / Report / Record / TXT / Config` 主要可见文本逐步迁移至 `strings.xml`（`values` / `values-zh` / `values-ja`），减少硬编码文案导致的语言不一致。
* **Report 阶段二（图表模式）**：结果区新增 `文字 / 图表` 切换；图表模式支持根节点下拉、最近天数输入、`加载图表`，并以 `Compose Canvas` 渲染最近 N 天时长折线图。
* **Report 结果模式切换位置稳定化**：将 `文字 / 图表` 切换条固定放在 `Day/Month/Week/Year/Range/Recent` 模式 tabs 下方，避免切换后控件位置跳动。
* **Report 图表模式参数聚焦**：切换到 `图表` 模式时隐藏 `Day/Stats/Project Tree Parameters` 纯文本参数卡，仅保留图表参数与图表结果区域，减少认知负担并对齐 Material 3 渐进披露。
* **Report 图表桥接能力**：`QueryGateway` 新增图表查询接口，Runtime 透传 `root + lookbackDays` 到 core `report_chart`，解析结构化 JSON 为 `chartPoints`。
* **Report 图表文案三语补齐**：图表模式新增可见文案已同步至 `values / values-zh / values-ja`，切换中文/英文/日语可即时生效。

### 补充更新（2026-02-21）

* **Data 页面新增单 TXT 导入入口**：新增 `Import Single TXT` 按钮，支持通过系统文档选择器导入单个文本文件。
* **单 TXT 导入改为“只按内容头判月”**：导入时只解析文件内 `yYYYY + mMM` 头信息确定目标月份，不再依赖文件名中的日期。
* **同月文件覆盖与入库联动**：导入后统一写入 Android 受管目录 `input/full/YYYY-MM.txt`；若目标月已存在则覆盖，然后调用 core `single_txt_replace_month` 完成当月替换入库。
* **Config 页面导入升级为双模式**：新增 `Import Android Config (Full Replace)` 与 `Import Android Config (Partial Update)` 两个入口，均使用系统目录选择器导入。
* **Full Replace 维持严格全量策略**：导入严格命中固定白名单路径（与导出共用同一策略），并在替换前完成路径合法性、重复路径、TOML 语法、`meta/bundle.toml` 的 `profile="android"` 与必需文件完整性校验；任一失败整体中止。
* **Partial Update 支持“按固定文件名”局部更新**：从所选目录递归收集 TOML，仅识别固定白名单文件名并映射到标准目标路径；识别到几个就校验并更新几个，未识别文件跳过；若包含 `meta/bundle.toml` 仍要求 `profile="android"`。
* **TOML 替换支持失败回滚**：导入前先读取旧配置做备份；替换过程中若任一文件写入失败，按已替换文件逆序回滚，避免出现“只替换一半”的状态。
* **Runtime 初始化改为不覆盖已导入配置**：`RuntimeEnvironment` 中 config 资产同步策略调整为“仅缺失补齐，不覆盖已有文件”，避免后续初始化覆盖用户导入 TOML。

### 补充更新（2026-02-21）第二次

* **统一错误日志 Phase 3：Android 接入内核日志路径（Step 1-2 + Step 4）**：
  * `native_bridge_calls.cpp`：`NativeInit` 成功响应内容从裸字符串 `\"initialized\"` 改为结构化 JSON，路径通过 `GetCurrentRunErrorLogPath()` 从内核获取，写入 `error_log_path` 字段。
  * `RuntimeGatewayModels.kt`（contract 模块）：`NativeCallResult` 新增 `errorLogPath: String = \"\"`，向后兼容。
  * `NativeRuntimeController.kt`：`initializeRuntimeInternal()` 解析 content JSON 中的 `error_log_path` 填入结果，Kotlin 层无需自行推导日志路径。
  * `RuntimeEnvironment.kt`：新增 `cleanupOldErrorLogs()` 保留策略（最多保留最近 50 个 `errors-*.log`，不删 `errors-latest.log`）；`prepareRuntimePaths()` 末尾调用，防止日志目录无限增长。

### 补充更新（2026-02-22）

* **Report 图表平均时间展示修正**：`Chart Type` 维持 `Line / Bar / Pie` 三种类型，不再新增独立 `Average` 标签。
* **图表结果统一增加平均时长**：在 `Line / Bar / Pie` 三种图表下统一展示当前范围平均时长，主路径优先使用 core 返回的 `average_duration_seconds`，并与已选点详情同时显示。
* **Android App 版本号更新**：`versionName` 与 Config About 展示版本统一调整为 `0.2.0`。

### 补充更新（2026-02-22）第二次

* **Report Chart 统计字段消费收口**：Android `report-chart` 解析新增 `average_duration_seconds` / `total_duration_seconds` / `active_days` / `range_days`，并在 ViewModel 状态中透传到图表 UI。
* **平均线与平均值统一以 core 为主**：折线图平均线与下方平均时长文案统一优先使用 core 统计字段，历史 payload 仍保留本地计算 fallback。
* **fallback 生命周期标注**：在图表平均值与平均线 fallback 代码处补充注释，计划在一个兼容周期后（目标 `Android v0.3.0`）移除本地统计回退路径。
* **Android fallback 测试补齐**：新增 runtime 解析测试（含“旧 payload 无统计字段”场景）与 ViewModel fallback 用例，固定“无统计字段时保持 `null` 供 UI 回退”契约。

### 补充更新（2026-02-22）第三次

* **Bar 图新增平均值横线开关**：在 Report 页 `Chart Type = Bar` 时，新增与 `Line` 相同的“显示平均线”开关，并在柱状图中绘制平均值虚线横线。
* **平均线开关 UI 复用**：`Line / Bar` 共用同一套开关行组件与显示条件，避免重复维护两套开关文案与交互逻辑。
* **平均线计算逻辑复用**：`Line / Bar` 统一复用平均值解析与 Y 轴换算函数，继续遵循“优先使用 core 统计字段，旧 payload 走 fallback”策略。
* **开关状态持久化约定补齐**：沿用 DataStore 键 `report_chart_show_average_line` 记忆用户开关状态，并在 `specs/preference-storage.md` 同步补充该键与默认值说明。

### 补充更新（2026-02-22）第四次

* **NavigationBar Tab 架构重构（Phase 0 ~ Phase 2）**：完成 Tabs 重构前 3 个阶段的落地，实现从“数字下标路由”到“类型化 + 单一注册表”的迁移。
* **引入类型化 Tab 模型**：新增 `TracerTab`（`DATA / REPORT / RECORD / TXT / CONFIG`）与 `TabMeta`，替换 app 层主流程中的 `selectedTab: Int` 业务判断。
* **引入 `TracerTabRegistry` 单一来源**：统一维护 tab 顺序、标题、图标、内容入口与滚动策略；`TracerScreenShell` 和 `TracerScreenRouting` 改为只消费注册表。
* **状态/行为兼容保持不变**：`TracerScreenStatus` 改为 typed tab 分发，同时保留 TXT 页“仅内联状态，不弹全局 Snackbar”的既有行为。
* **重构基线与 ADR 补齐**：在 `temp/tabs_refactor.md` 补充 Phase 0 行为矩阵与完成标记；新增 ADR：`apps/tracer_android/docs/adr/0001-typed-tab-and-registry.md`。
