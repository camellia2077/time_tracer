## [v0.2.1] - 2026-02-23

### Report Markdown 列表层级修复（2026-02-26）
- 修复 Android 端 Markdown 报告中 `Project Breakdown` 层级平铺问题：
  - 原因是列表解析阶段对行内容进行了 `trim()`，导致前导缩进信息丢失。
  - 修复后保留列表项缩进并按层级渲染，`- /  - /    -` 等嵌套关系可正确展示。
- 说明：
  - 该修复属于当前阶段的兼容性改动（短期方案），用于快速恢复多级树的可读性。
  - 后续将推进以“同一份语义模型（DTO/IR）”为核心的渲染链路，统一驱动 `JSON / Markdown / LaTeX / Typst` 输出，确保多端复用与 Markdown/LaTeX/Typst 一致性。

### Report Markdown 标题折叠与标题清洗（2026-02-26）
- Report 文本结果区支持按标题手动展开/折叠：
  - 标题行可点击切换（`▼ / ▶`）
  - 默认全部展开
- 折叠联动修复：
  - 折叠父标题（如 `##`）时，其下子标题（如 `###`）与正文会一并隐藏。
- 标题渲染清洗：
  - 修复类似 `### title ###` 在 UI 中显示尾部 `###` 的问题，现仅显示标题正文。

### Report 模式结果隔离修复（2026-02-26）
- 修复 Report tab 在 `day -> month`（以及其他模式切换）时结果串显示的问题：
  - 之前切换模式后，可能继续显示上一次模式（如 day）的报告内容。
- 当前行为：
  - day/month/week/year/range/recent 各模式维护各自结果；
  - 切换模式时仅显示当前模式对应的报告，不再跨模式复用上一次结果。

### TRACER 导出安全等级可选（2026-02-26）
- Data 页 `Export TRACER` 上方新增安全等级选择：
  - `INTERACTIVE`（默认）
  - `MODERATE`
  - `HIGH`
- 导出时所选等级会通过 Android runtime/JNI 透传到 core 加密链路。
- 兼容性：
  - 仅新增可选能力，不改变既有导入导出入口与使用方式。

### 批量 TRACER 加解密性能优化同步（2026-02-26）
- Android 端在目录批量导入/导出场景已同步受益于 core 批量会话密钥优化：
  - 同一批次内优先复用主密钥并派生子密钥，减少重复 KDF。
- 用户侧体验：
  - 多文件批量加解密等待时长降低，尤其在移动端更明显。
- 文件兼容性保持不变：
  - 继续兼容历史 `.tracer` 文件格式。

### 批次 ETA 展示修复（2026-02-26）
- 修复导入 `.tracer` 时“预计剩余时间长期显示 `00:00`”的问题：
  - 进度详情中的 ETA 改为按批次估算（基于 `overallProgress + elapsed`），不再仅依赖单文件 `eta_seconds`。
- 回退策略：
  - 当批次估算样本不足（如刚启动、进度接近 0）时，自动回退到单文件 ETA 逻辑，避免显示抖动。
- 影响范围：
  - Data 页加解密进度卡片（含目录批量导入/导出场景）。
  - 仅优化展示与估算策略，不改变导入导出功能与文件格式。

### TRACER 导入/导出加解密进度打通（2026-02-26）
- Android 端已接入 core 文件加解密进度事件（JNI -> runtime -> ViewModel -> UI），支持导出 `TXT -> TRACER` 与导入 `TRACER -> TXT` 过程的实时反馈。
- Data 页新增双层进度展示：
  - 总体进度：跨文件处理进度（txt completed/total）
  - 当前进度：当前文件处理百分比（含 folder/month 信息）
- 进度详情展示新增动态字段：
  - `speed_bytes_per_sec`
  - `remaining_bytes`
  - `eta_seconds`
- 结果态补齐：
  - 处理中 / 完成 / 失败 / 已取消 文案统一落在同一进度卡片区域。
- 兼容性：
  - 仅新增能力，不改变既有导入导出命令与数据格式。

### Crypto 进度契约同步（2026-02-26）
- 与 `tracer_core` 的文件加解密进度快照契约保持同步，core 侧新增字段：
  - `speed_bytes_per_sec`
  - `remaining_bytes`
  - `eta_seconds`
- 该变更用于后续 Android 导入/导出进度 UI（总体进度 + 分组进度）展示扩展。
- 当前版本说明：
  - Android UI 端尚未开启这三项指标的可视化渲染；
  - 现有流程兼容不受影响（新增字段默认 `0` 时不改变既有行为）。

### Android Tabs Refactor Phase 3（Thin Shell + Tab Entries）
- `TracerTabEntry` 合同扩展为：
  - `content(...)`
  - `onEnter(...)`
  - `onLeave(...)`
  - `statusText(...)`
- 将 tab 专属行为从 `TracerScreen` 下沉到 `TracerTabRegistry`：
  - `CONFIG` 进入时刷新配置：`refreshConfigFiles()`
  - `RECORD` / `TXT` 进入时刷新 activity mapping 校验源
  - `TXT` 离开时丢弃未保存编辑草稿：`discardUnsavedHistoryDraft()`
  - `CONFIG` 离开时丢弃未保存 TOML 草稿：`discardUnsavedDraft()`
- `TracerScreen` 收敛为协调器（Coordinator）：
  - 仅维护 `selectedTab` 与依赖注入
  - 通过统一 hook 分发 tab 切换与生命周期事件（含 `ON_STOP`）
  - 移除 tab 业务 `if/when` 分支
- 状态文本解析改为 tab entry 自管：
  - 使用 `TracerTabRegistry.statusText(...)`
  - 删除中心化 `statusTextForSelectedTab(...)` 分发函数
- 行为保持：
  - 保持 TXT tab 仅内联状态展示，global snackbar 不在 TXT tab 再次弹出
  - 保持 export details 跳转 TXT 的既有行为

### Android Tabs Refactor Phase 4（Module Boundary Hardening）
- Report tab 的表现层入口下沉到 `feature-report`：
  - 新增 `QueryReportTabContent`，统一承载 report 参数区与结果区（文本/图表/错误）渲染。
  - app 模块不再持有 report 专属结果卡片渲染实现。
- Record tab 的表现层入口下沉到 `feature-record`：
  - 新增 `RecordTabContent`（feature 内入口），并移除 app 层 `TracerScreenRecordTab.kt`。
  - 记录页偏好写回改为稳定回调注入（由 app 组合根注入持久化逻辑），降低 feature 对 app 实现耦合。
- `TracerTabRouteArgs` 改为 entry 级稳定契约：
  - 引入 report 图表偏好回调与 record 偏好持久化回调。
  - app 保持 composition root 角色，不再承载 feature 细节 UI 逻辑。
- 说明：
  - `feature-config` 物理模块拆分仍保留为可选后续步骤，本次先完成入口边界收敛与跨 feature 泄漏压缩。

### Android Tabs Refactor Phase 5（Status + Event Unification）
- 引入统一 typed 事件管道：
  - `TracerTabUiEvent`：tab 层 UI 事件（如 snackbar）。
  - `TracerCoordinatorEvent`：协调层事件（如显式 tab 导航）。
- `TracerTabEntry` 新增 `statusEvent(...)`：
  - 每个 tab 可独立提供状态事件策略（TXT 保持 inline-only，不触发全局 snackbar）。
  - partial export completion 通过 typed action 显式触发 `SelectTab(TXT)`。
- `StatusSnackbarEffect` 改为事件消费器：
  - 仅消费 `TracerTabRegistry.statusEvent(...)` 输出，不直接持有业务分支。
  - snackbar action 统一上抛为协调事件，由 `TracerScreen` 统一处理。
- `TracerScreen` 协调器职责进一步收敛：
  - 底部导航切换与 snackbar action 跳转都走 `dispatchCoordinatorEvent(...)`。
  - 状态处理路径显式、可追踪、typed。

### Android Tabs Refactor Phase 6（Verification + Cleanup + Docs）
- 测试升级（app 层单测）：
  - 新增 `TracerTabRegistryTest`，覆盖以下核心点：
    - registry 完整性（5 个 tab 全量存在且顺序稳定）
    - tab hook 行为（`onEnter` / `onLeave`）
    - status/snackbar 事件策略（含 partial export 触发 typed `SelectTab(TXT)`）
    - TXT tab 的全局 snackbar 抑制策略
- 迁移遗留清理：
  - 删除不再使用的 legacy 适配函数：
    - `TracerTab.toLegacyTabIndex()`
    - `tracerTabFromLegacyIndex(...)`
- 结构文档补齐：
  - 新增 `docs/time_tracer/clients/android_ui/specs/STRUCTURE.md`（tab -> entry -> viewmodel，coordinator/shell 边界，事件流）
  - `apps/tracer_android/agent.md` 新增 Structure 文档链接，保证入口可发现。

### Android Runtime Refactor Phase 6（Observability + Diagnostics）
- core 调用链统一接入 `operationId`（init/query/report/record/ingest 路径）。
- 结果模型扩展诊断字段（兼容默认值）：
  - `NativeCallResult` / `ReportCallResult` / `ClearAndInitResult` 等新增 `operationId`。
  - query/report/suggestion/mapping 等结果新增 `operationId` 透传。
- 新增结构化诊断记录：
  - `RuntimeDiagnosticsRecorder`（in-memory recent + JSONL）
  - 日志路径：`<runtime>/output/logs/diagnostics.jsonl`
- 运行时网关新增诊断能力：
  - `listRecentDiagnostics(limit)`
  - `buildDiagnosticsPayload(maxEntries)`
- Config About 卡新增 `Copy Diagnostics Payload`，用于用户支持载荷复制。
- 错误文本与日志字段对齐：
  - 失败消息可携带 `op=...` 与 `log=...` 关联上下文（当可用时）。

### Android Runtime Refactor Phase 7（Config/Asset Lifecycle）
- 启动完整性检查接入 runtime：
  - `RuntimeEnvironment.prepareRuntimePaths()` 增加 `bundle.toml` 校验。
  - 校验项：`schema_version`、`profile=android`、required files 存在性。
- 新增配置 bundle 校验组件：
  - `RuntimeConfigBundleValidator`
- 保留最近一次 bundle 校验状态，并纳入 diagnostics payload。
- 配置生命周期文档化：
  - 新增 `docs/time_tracer/clients/android_ui/specs/CONFIG_ASSET_LIFECYCLE.md`。
- 模块物理拆分评估结论：
  - 当前保持包内分层与契约稳定，暂不执行 `:runtime-core-adapter` / `:runtime-services` 物理拆分。

### Docs Cleanup（路径收敛）
- Android 文档从 `apps/tracer_android` 收敛到 `docs/time_tracer/clients/android_ui/specs/`：
  - `STRUCTURE.md` -> `docs/time_tracer/clients/android_ui/specs/STRUCTURE.md`
  - `CONFIG_ASSET_LIFECYCLE.md` -> `docs/time_tracer/clients/android_ui/specs/CONFIG_ASSET_LIFECYCLE.md`
- `apps/tracer_android/agent.md` 链接已更新到新路径。

### Tree Structured Pipeline（Phase 4/5）
- Contract 层新增结构化 Tree 结果模型：
  - `TreeNode`
  - `TreeQueryResult`（含 `operationId`、compat fallback 字段）
- Runtime 查询链路新增结构化入口：
  - `nativeTree`（JNI） -> `runtime_tree_json`（core C ABI）
  - `RuntimeQueryDelegate.queryProjectTree` 默认走结构化 payload 解析。
- 兼容策略：
  - 保留 `queryProjectTreeText`（legacy `query data tree` 文本路径）。
  - 当结构化链路不可用时，自动回落到 legacy text fallback，避免升级窗口回归。
- Feature Report 的 Tree 结果区从纯文本展示升级为结构化树渲染（层级缩进 + 展开/折叠），并支持 fallback 文本显示。

### 验证
- `python scripts/run.py build --app tracer_android --profile fast` 通过（`BUILD SUCCESSFUL`）。
- `python scripts/verify.py --app tracer_android --profile android_style --concise` 通过（0 errors）。
- `python scripts/verify.py --app tracer_android --profile android_ci --concise` 通过：
  - Gradle gate：`:app:ktlintCheck :app:lintDebug :app:testDebugUnitTest :app:lintRelease`
  - Suite 结果：`test/output/tracer_android/result.json` -> `total=15`, `failed=0`, `success=true`
- `python scripts/run.py post-change --app tracer_android` 通过：
  - `test/output/tracer_android/result.json` -> `total=12`, `failed=0`, `success=true`
  - `test/output/tracer_android/result_cases.json` -> `total_cases=12`, `total_failed=0`
