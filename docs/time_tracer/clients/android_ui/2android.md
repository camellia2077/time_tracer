# Android 业务数据协议讨论：JSON vs C struct

## 当前事实

Android 已经用了 C ABI 边界（`tracer_core_*`），但业务请求/响应仍是 JSON 字符串。

链路：
1. Kotlin/Compose -> JNI
2. JNI -> `tracer_core_*` C ABI
3. C ABI 参数/返回：`const char*` JSON

## 结论（建议）

当前阶段继续用 JSON 作为业务协议，不建议现在切到 C struct。

原因：
1. 跨语言成本低：Kotlin、未来 Python/Rust 都更容易接 JSON。
2. ABI 演进更稳：字段增减对旧调用方更友好。
3. 当前瓶颈不在协议：你们主要是文件 IO、数据库、报表流程，不是超高频毫秒级 RPC。

## 对比

### JSON 优点
1. 可读性好，调试简单（日志直接可看）。
2. 版本兼容性强（可选字段、默认值容易做）。
3. 多端复用成本低（Android/Windows/未来语言）。

### JSON 缺点
1. 序列化/反序列化有开销。
2. 编译期类型约束弱，字段拼写错误要靠测试兜底。

### C struct 优点
1. 理论性能更高（减少解析开销）。
2. 类型边界明确（头文件即契约）。

### C struct 缺点
1. ABI 稳定性难：对齐、字节布局、编译器差异、内存所有权都要严格规范。
2. Kotlin/JNI 映射复杂，维护成本明显上升。
3. 协议演进困难：加字段就可能影响兼容。

## 什么时候再考虑 C struct

满足以下条件再切：
1. 已经确认性能瓶颈在 JSON 编解码（有 profiler 证据）。
2. 某个热点接口调用频率高、数据量大（如大批量查询返回）。
3. 团队愿意维护严格 ABI 规范（版本号、内存释放规则、兼容策略）。

## 推荐路线

1. 近期：维持 JSON 协议，继续收敛字段命名与 schema 校验。
2. 中期：先做“热点识别 + 基准测试”，不要先改协议。
3. 长期：若必须优化，优先“局部二进制化”，不要全量改成 C struct。
