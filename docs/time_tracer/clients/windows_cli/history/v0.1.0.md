## [v0.1.0] - 2026-02-21

### Thin CLI 收敛（来自 `temp/thin_cli_size.md`）
- 完成 Step 1~17，Windows CLI 从“半薄壳”收敛到更轻实现层。
- 运行时职责下沉到 core C ABI：
  - `tracer_core_runtime_check_environment_json`
  - `tracer_core_runtime_resolve_cli_context_json`
- `cli_runtime_factory` 完成物理拆分：
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory.cpp`（装配层）
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_support.cpp`（实现层）
- 命令注册改为显式注册入口，移除 `WHOLE_ARCHIVE` 强拉入。
- `release_safe` 体积结果（对比基线）：
  - `time_tracer_cli.exe`：`486,400 -> 405,504` bytes（`-16.63%`）
  - `.text`：`-18.43%`
  - `.rdata`：`-11.29%`
- 回归验证通过：
  - `test/run_time_tracer.bat -b build`：`124` 通过，`0` 失败。
  - runtime guard（缺 config / 缺 core dll / capabilities）通过。

### Thin Bootstrap 线性计划增量（`temp/1thin_bootstrap.md`）
- 完成 Step 5：将 CLI 本地运行时检查收敛为仅检查 `time_tracer_core.dll` 存在性，移除对 `libreports_shared.dll`、`libsqlite3-0.dll`、`libtomlplusplus-3.dll` 与 `config/config.toml` 的本地硬检查。
- 完成 Step 10~14：在 `apps/tracer_windows/src/bootstrap/cli_runtime_factory_support.cpp` 内完成文件内分段与最小接口收敛：
  - `codec`：保留 JSON 解析与 `ParseTreePayload`。
  - `loader`：收敛动态加载、错误转换、符号绑定（`BindCoreApiSymbols`）。
  - `check`：收敛 CLI 最小检查与 core check/resolve 结果解析。
  - `proxy`：保持 `CoreApiProxy` 行为不变，仅改用 `codec` 解析树响应。
- 保持加载前 fail-fast：`CoreLibrary::LoadFromExeDir` 继续负责核心库不存在、加载失败、必需 C ABI 符号缺失时即时失败。
- 使用统一入口验证通过：`python scripts/verify.py --app time_tracer --profile release_safe --build-dir build --concise`。
  - `test/output/time_tracer/result.json`：`total_tests=124`，`total_failed=0`。
  - native core runtime tests：`time_tracer_core_c_api_smoke_tests` 与 `time_tracer_core_c_api_stability_tests` 通过。

### Thin Bootstrap 物理拆分增量（Step 16~20）
- 完成 Step 16：新增 `loader` 物理模块并迁移加载与符号绑定实现：
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_loader.hpp`
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_loader.cpp`
- 完成 Step 17：新增 `check` 物理模块并迁移 CLI 最小检查与 core-check 解析适配：
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_check.hpp`
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_check.cpp`
- 完成 Step 18：新增 `proxy` 物理模块并迁移 `CoreApiProxy` 与树响应 codec 适配：
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_proxy.hpp`
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_proxy.cpp`
- 完成 Step 19：调整 CMake 接入新增 TU，并移除单体实现文件接入：
  - `apps/tracer_windows/src/api/cli/CMakeLists.txt`
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_support.cpp`（删除）
  - `apps/tracer_windows/src/bootstrap/cli_runtime_factory_support.hpp`（改为聚合入口）
- 完成 Step 20：回归验证通过：
  - `python scripts/verify.py --app time_tracer --profile release_safe --build-dir build --concise`
  - `test/output/time_tracer/result.json`：`total_tests=124`，`total_failed=0`，`success=true`。
  - native core runtime tests：`time_tracer_core_c_api_smoke_tests` 与 `time_tracer_core_c_api_stability_tests` 通过。

### Windows CLI 终端重复打印修复
- 修复 ingest/validate 失败时“同一份校验错误在终端重复打印两遍”的问题。
- 根因：结构化校验错误已经由 `ValidationIssueReporter` 实时输出；失败异常再次拼接 buffered diagnostics，最终在 CLI 顶层 `Logic Error` 中重复出现。
- 处理方式：
  - 在 `apps/time_tracer/src/application/workflow_handler.cpp` 新增统一失败消息构造，仅保留主错误与 `errors.log` 路径，不再拼接 `Validation details` 明细。
  - 覆盖 `RunIngest` / `RunValidateStructure` / `RunValidateLogic` 三条失败路径。
- 同步修复日志前缀重复：将 `apps/time_tracer/src/application/pipeline/pipeline_manager.cpp` 中 `" [INFO] Loading Configuration..."` 改为 `"Loading Configuration..."`，避免输出 `[INFO] [INFO] ...`。
- 验证：
  - `python scripts/run.py build --app tracer_windows --profile fast` 构建通过。
  - `apps/tracer_windows/build_fast/bin/time_tracker_core_api_tests.exe` 通过。
  - 使用最小非法 TXT 复现后，终端仅保留一份详细校验错误，`Logic Error` 不再重复整段明细。

### Export 目录清理修复（避免空 `data/db`）
- 修复 `export` 命令在默认导出目录（如 `exported_reports`）下生成空 `data/` 与 `db/` 目录的问题。
- 根因：runtime 初始化阶段统一执行 `PrepareOutputDirectories`，会预创建 `output_root/data` 与 `output_root/db`；当 `export` 路径被当作 runtime output root 时，这两个空目录会落在导出目录中。
- 处理方式：将 `PrepareOutputDirectories` 调整为仅创建根目录，不再预创建 `data` 与 `db` 子目录。
  - `modules/tracer_adapters_io/src/infrastructure/io/file_io_service.cpp`
- 结果：`exported_reports` 仅用于报告文件（markdown/typ/tex）；`db` 与 `data` 继续位于 `output` 体系（按需创建）。
- 验证：
  - `python scripts/run.py build --app tracer_windows --profile fast` 构建通过。
  - `apps/tracer_windows/build_fast/bin/time_tracker_core_api_tests.exe` 通过。
  - `time_tracer_cli.exe export all-day --format md,typ` 后检查：`exported_reports/data`、`exported_reports/db` 均不存在。

### 错误日志目录与命名规范落地（ISO + latest）
- 调整错误日志默认落点为 `<exe>/output/logs/`，不再跟随导出目录（`exported_reports`）。
- 新增按运行实例隔离的 ISO 文件名（UTC，Windows 安全文件名）：
  - `errors-YYYY-MM-DDTHH-MM-SSZ.log`
  - 示例：`errors-2026-02-21T12-54-10Z.log`
- 同时保留固定入口文件：
  - `errors-latest.log`
  - 每次运行启动时先截断该文件，再在后续写入中与本次 ISO 文件同步追加内容。
- 终端提示路径改为“本次 ISO 文件路径”（便于精确定位单次运行日志）。
- 相关实现：
  - `apps/time_tracer/src/api/android/android_runtime_factory.cpp`
  - `apps/time_tracer/src/infrastructure/logging/file_error_report_writer.hpp`
  - `apps/time_tracer/src/infrastructure/logging/file_error_report_writer.cpp`
- 验证：
  - `python scripts/run.py build --app tracer_windows --profile fast` 构建通过。
  - `apps/tracer_windows/build_fast/bin/time_tracker_core_api_tests.exe` 通过。
  - 失败复现时终端打印：
    - `.../output/logs/errors-YYYY-MM-DDTHH-MM-SSZ.log`
  - 目录检查：
    - `output/logs/errors-*.log` 与 `output/logs/errors-latest.log` 同时存在。

### 统一错误日志系统（Phase 1 + Phase 2）

#### Phase 1：内核统一错误日志基础设施

- 新增 `domain/errors/error_record.hpp`：定义 `ErrorRecord` 结构体（含 `code`, `severity`, `message`, `details`, `source`, `timestamp_utc`, `run_id`）与 `ErrorSeverity` 枚举。
- 新增 `domain/errors/error_codes.hpp`：按 dot-style 分组的 `constexpr std::string_view` 错误码常量（validation / pipeline / import / export / runtime / io / config 七个 namespace，共 ~25 个常量）。
- 修改 `domain/ports/diagnostics.hpp/cpp`：
  - 新增 `ClearDiagnosticsDedup()`：重置会话级 Emit 去重集合。
  - 新增 `GetCurrentRunErrorLogPath()`：返回当前运行 ISO 日志文件路径（`GetErrorReportDestinationLabel()` 的语义别名）。
  - `EmitAndBuffer` 添加 `g_dedup_set` 门：同一消息在同一 session 内只输出一次到终端，文件写入不受影响。

#### Phase 2：Windows CLI 复用

- `android_runtime_factory.cpp`（Windows CLI 与 Android 共用）：
  - `SetErrorReportWriter` 之后立即调用 `ClearBufferedDiagnostics()` + `ClearDiagnosticsDedup()`，确保每次 `tracer_core_runtime_create` 以干净的 diagnostics 状态开始。
- Gap 分析结论：Windows CLI 层无本地路径拼接，终端输出由核心 `EmitInfo` 携带路径，catch 块仅打印 `e.what()`，已满足"阶段二"全部要求；本次仅补充 session reset 调用。

#### 验证
- `python scripts/verify.py --app time_tracer --quick`
  - 结果：`Total: 124, Failed: 0`。
