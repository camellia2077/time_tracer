## [v0.6.0] - 2026-02-13

### Summary
* 为安卓开发复用代码优化架构。
* 建立 Windows/Android 最小同步保障基线（端口契约、占位实现、检查脚本、PR 约束）。

### 新增功能 (Added)
* 新增 **Core DTO**：
  * `apps/time_tracer/src/application/dto/core_requests.hpp`
  * `apps/time_tracer/src/application/dto/core_responses.hpp`
* 新增 **Core UseCase** 接口与实现：
  * `apps/time_tracer/src/application/use_cases/i_time_tracer_core_api.hpp`
  * `apps/time_tracer/src/application/use_cases/time_tracer_core_api.hpp`
  * `apps/time_tracer/src/application/use_cases/time_tracer_core_api.cpp`
* 新增 `AppContext::core_api` 注入点，作为 `CLI` 与核心业务的统一桥接入口：
  * `apps/time_tracer/src/api/cli/impl/app/app_context.hpp`
  * `apps/time_tracer/src/api/cli/impl/app/cli_application.cpp`
* 新增 **Ports**：`ILogger`、`IProcessedDataLoader`、`ITimeSheetRepository`、`IDatabaseHealthChecker`、`IDataQueryService`。
* 新增 **Ports**：`IProcessedDataStorage`、`IConverterConfigProvider`。
* 新增 `application/dto/runtime_environment_requirements.hpp` 与 `application/ports/i_runtime_environment_validator.hpp`。
* 新增 **Infrastructure** 适配器 `runtime_environment_validator_adapter.*`。
* 新增 `domain/types/converter_config.hpp`。
* 新增 **Application** 时间/时区端口：`apps/time_tracer/src/application/ports/i_platform_clock.hpp`
  * `TodayLocalDateIso()` (`YYYY-MM-DD`)
  * `LocalUtcOffsetMinutes()`
* 新增 Android 平台时钟占位实现（可编译基线）：
  * `apps/time_tracer/src/infrastructure/platform/android/android_platform_clock.hpp`
  * `apps/time_tracer/src/infrastructure/platform/android/android_platform_clock.cpp`
* 新增跨端同步契约文档：
  * `docs/time_tracer/platform_sync_contract.md`
* 新增本地同步门禁脚本：
  * `scripts/check_platform_sync.ps1`
* 新增 PR 同步检查模板：
  * `.github/PULL_REQUEST_TEMPLATE.md`
* 新增平台目录占位（为后续多端扩展预留）：
  * `apps/time_tracer/src/infrastructure/platform/android/README.md`
  * `apps/time_tracer/src/infrastructure/platform/linux/README.md`
  * `apps/time_tracer/src/infrastructure/platform/ios/README.md`
  * `apps/time_tracer/src/infrastructure/platform/macos/README.md`

### 技术改进/重构 (Changed/Refactor)
* 重构 **Core API**：新增稳定的 `use_cases` + `dto` 外部调用面，并将主要 `CLI` 命令改为依赖统一核心入口。
* 重构 `formatter_config_payload`：职责拆分与编排重构，降低重复逻辑与参数误用风险。
* `apps/time_tracer/src/infrastructure/reports/shared/factories/formatter_config_payload.*`
  * `Build*` / `BuildFromLoaded*` 保留编排流程。
  * 新增模板化编排 helper：`BuildFromLoaded`、`BuildWithStrategy`、`InitializeConfigHeader`、`FinalizeConfig`。
  * 新增 `DayTypStatisticSizes`，替代 `PopulateDayTypConfig`，避免参数顺序误用。
* `apps/time_tracer/src/infrastructure/reports/shared/factories/formatter_config_payload_*.cpp`
  * 按职责物理拆分：`fillers`、`cview`、`lifecycle/reset`。
* `CLI` 命令层依赖由分散的 `IWorkflowHandler` / `IReportHandler` 收敛为 `ITimeTracerCoreApi`：
  * `convert` / `ingest` / `import` / `validate-structure` / `validate-logic`
  * `query` / `export`
  * 涉及路径：`apps/time_tracer/src/api/cli/impl/commands/pipeline/`
* 补齐 `CLI` 对 **Core API** 覆盖：`query data` 与 `query tree` 已改为通过 `ITimeTracerCoreApi` 执行。
* `query` / `export` 命令分发逻辑简化为 `type` -> `dto` -> `core_api` 路径。
* **Application** 层去技术耦合（面向多端演进）：
  * `workflow_handler` / `import_service` / `time_tracer_core_api` 改为仅依赖接口与 **DTO**。
* `query-data` 能力下沉到 `infrastructure/query/data/`：`sqlite_data_query_service` 与 `CLI` 均复用该模块。
* `apps/time_tracer/src/application/parser/text_parser.cpp`
  * `lambda` 增加 `trailing return type`。
  * 时间解析局部常量命名统一 (`kHour` / `kMinute`)。
* `apps/time_tracer/src/infrastructure/config/validator/reports/strategies/base_strategy.cpp` 内 `lambda` 改为 `trailing return type`。
* 重构 `StartupValidator` 端口化：由 `app_runner` 作为组合根注入，不再直接 include `infrastructure/*`。
* `application` 构建层解耦：`apps/time_tracer/src/application/CMakeLists.txt` 移除对 `time_tracker_infrastructure` 的直接链接。
* 收敛 **Domain** 模块：
  * `converter` 核心实现收敛为 `converter_core.hpp/.cpp`。
  * `validator` 规则收敛：`txt/rules` 合并为 `txt_rules.hpp/.cpp`，`structure` 合并为 `structure_validator.hpp/.cpp`。
* 收敛 **Infrastructure** 模块：
  * `markdown`、`typst`、`latex` 格式器将 `*_config.cpp` 内联到对应 `*_formatter.cpp`。
  * `daily` / `month` / `range` 链路配置碎片清理。
  * `I/O` 收敛为 `file_io_service.hpp/.cpp` 与 `processed_data_io.hpp/.cpp`。
  * 查询模型收敛为 `data_query_models.hpp`；序列化收敛为 `log_codec.hpp/.cpp`；SQL 常量入口统一为 `sqlite_schema.hpp`。
* 修改 **CLI** 工具层减少碎片化：
  * `help_formatter.*` 合并进 `console_helper.*`。
  * `date_utils.*` 合并进 `tree_formatter.*`。
* 新增 **Windows** 适配器：`apps/time_tracer/src/infrastructure/platform/windows/windows_platform_clock.hpp/.cpp`。
* 完成报告周期查询链路时钟注入：涉及 `period_querier`、`batch_period_data_fetcher`、`report_service` 等。
* 文件系统端口收口（不重构目录）：
  * 删除未使用链路：`IPipelineFileService` / `PipelineFileService`
  * 构建清单同步移除 `io/pipeline_file_service.cpp`
* 基础设施日志收口：
  * 除控制台适配器外，不再直接使用 `std::cout/cerr/println`，统一走 `application::ports::Log*` 或 `domain::ports::Emit*`。
* CLI 启动入口迁移：
  * `apps/time_tracer/src/main_cli.cpp` 迁移到 `apps/time_tracer/src/api/cli/main.cpp`
  * `apps/time_tracer/src/CMakeLists.txt` 入口路径同步更新。

### 修复 (Fixed)
* 修复 `test/run_log_generator.bat` 默认构建目录与实际二进制目录不一致问题，统一为 `build_fast`。
* 修复 `test/suites/log_generator/env.toml` 的 `default_build_dir` 为 `build_fast`。
* 修复 `daily` / `month` / `year` 等命令相关记录，确保不使用 `-ly` 形式。

### 验证 (Verification)
* Windows 门禁通过：
  * `python scripts/run.py build --app time_tracer`
  * `ctest --test-dir apps/time_tracer/build_fast --output-on-failure`
  * `python test/run.py --suite time_tracer --agent --build-dir build_fast --concise`
* 平台同步脚本通过：
  * `pwsh ./scripts/check_platform_sync.ps1`
  * `pwsh ./scripts/check_platform_sync.ps1 -RunWindowsChecks`
* `test/output/time_tracer/result.json`：`success=true`，`total_tests=108`，`total_failed=0`。
