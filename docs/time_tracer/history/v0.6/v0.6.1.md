## [v0.6.1] - 2026-02-15

### 新增功能 (Added)

* 新增 Android 依赖装配模块 `apps/time_tracer/cmake/AndroidDependencies.cmake`
* 新增 Android JNI API 目标与桥接实现：
  * `apps/time_tracer/src/api/android/CMakeLists.txt`
  * `apps/time_tracer/src/api/android/native_bridge.cpp`
* 新增 **AndroidRuntimeFactory**（`android_runtime_factory.hpp` / `android_runtime_factory.cpp`），使用显式参数 `db_path` / `output_root` / `converter_config_toml_path`
* 新增报告范围查询类型与端口：
  * `core_requests.hpp` 新增 `ReportQueryType::kRange`
  * `core_responses.hpp` 新增 `StructuredReportKind::kRange`
  * `i_report_data_query_service.hpp` 新增 `QueryRange(start_date, end_date)`
* 新增范围查询器 **DateRangeQuerier** 并接入 **SqliteReportDataQueryService**
* 新增 Android 静态 formatter 注册器 **AndroidStaticReportFormatterRegistrar**
* 新增 formatter parity 测试与 golden 快照（`report_formatter_parity_tests.cpp` / `golden/formatter_parity/`）
* 新增 ABI wrapper 模板基座 `formatter_abi_wrapper_template.hpp`
* 新增 range/month 共享视图转换工具 `range_report_view_utils.hpp`
* 新增 data query 活动推荐动作 `DataQueryAction::kActivitySuggest`：
  * `DataQueryRequest` 新增 `lookback_days` / `activity_prefix` / `activity_score_by_duration`
  * 默认"出现频率 + 近期衰减"，支持可选按时长加权
* 新增活动推荐查询模型与渲染（`data_query_types.hpp` / `data_query_repository.*` / `data_query_models.hpp` / `data_query_output.cpp`）
* 新增 data query 树查询动作 `DataQueryAction::kTree`：
  * `DataQueryRequest` 新增 `tree_period` / `tree_period_argument` / `tree_max_depth`
  * `query data tree --period ...` 支持 `day/week/month/year/recent/range` 六类周期，支持 `--level` 控制树深度
* 新增周期树查询仓储接口 `QueryLatestTrackedDate(sqlite3*)` / `QueryProjectTree(sqlite3*, const QueryFilters&)`
* 新增 C++ `range` 报告接口并打通 Android 端 Markdown 范围报告链路

### 技术改进/重构 (Changed/Refactor)

* 完成 **001-core 第 1 步**（构建系统去平台耦合）：
  * `apps/time_tracer/CMakeLists.txt` 增加 `ANDROID` 分支依赖配置
  * `infrastructure_core_sources.cmake` 按平台选择 `android_platform_clock.cpp` / `windows_platform_clock.cpp`
  * `apps/time_tracer/src/CMakeLists.txt` Android 构建走 `api/android`，非 Android 走 CLI
  * `BuildTypeFlags.cmake` Android 下跳过 `-march=native`
* 完成 **001-core 第 2 步**（Android runtime factory）：
  * 运行时装配注入 **AndroidPlatformClock** 与可注入日志/诊断 sink
  * 转换配置提供器改为 **FileConverterConfigProvider**，从 TOML 文件加载
  * `android_runtime_factory_tests.cpp` 覆盖 runtime 初始化与查询/报表调用
* 完成 **001-core 第 3 步**（报表链路首版降级）：
  * Android 下不构建动态格式化插件子目录
  * 从首版静态 Markdown 降级路径升级为"静态注册 + core 复用"路径，规避 `plugins` 动态加载硬依赖
* 重构 formatter 架构（跨端可维护性）：
  * 将 `day/month/range` 下 `Markdown/LaTeX/Typst` 的核心格式化逻辑拆分为 `*_formatter_core.cpp`
  * DLL 导出层收敛为 ABI wrapper（`tt_createFormatter` / `tt_formatReport` / `tt_getLastError`）
  * Android 静态注册器复用同一 core 构造路径，不再维护独立静态格式化实现
* 升级 Android 静态注册器为"表驱动注册矩阵"：
  * 以 `report format + day/month/period/week/year builder` 统一声明注册行
  * 策略关闭格式时，统一注册"禁用 creator"并返回明确错误信息
  * 默认 `MarkdownOnly()`，提供 `AllFormats()` 供 parity/测试覆盖
* 模板化 9 个插件 ABI wrapper（去重）：
  * `day/month/range` × `markdown/latex/typst` 的 `tt_*` 导出逻辑改为 traits + 模板复用
  * 单插件文件仅保留类型参数、config 提取函数与 formatter 名称
* 去重 range/month 视图转换逻辑：`BuildMonthlySummaryData` / `BuildRangeSummaryData` 收敛到共享工具
* 调整 parity 测试层次：删除对 `GenericFormatterFactory<...>::GetCreators().clear()` 的直接依赖，改为仅通过公共 registry 入口注册
* 统一 **MonthTexFormatter** `IsEmptyData` 规则为 `actual_days == 0`，与 md/typ 对齐
* 同步构建清单与插件目标（`infrastructure_reports_sources.cmake` / 各 `CMakeLists.txt`）
* 收敛 JNI 边界为强类型参数（替代请求 JSON）：
  * `nativeInit(dbPath, outputRoot, converterConfigTomlPath)`
  * `nativeIngest(inputPath, dateCheckMode, saveProcessedOutput)`
  * `nativeQuery(...)` / `nativeReport(...)` 使用枚举码与显式字段参数
* 扩展 `RunStructuredReportQuery` 新增 `kRange` 分支：
  * 支持 `start|end` 与 `start,end` 两种参数分隔形式
  * 严格校验 ISO 日期格式（`YYYY-MM-DD`）与 `start <= end`
* 扩展 structured report 格式化链路支持 `kRange`（`time_tracer_core_api_helpers.cpp`）
* 扩展 Android JNI 报告类型新增范围码：
  * `native_bridge.cpp` 映射 `report_type=5 -> kRange`
  * `NativeBridge.kt` 新增 `REPORT_TYPE_RANGE = 5`
* 切换 Android runtime `reportRange` 从 query 链路到 report 链路：
  * 从 `nativeQuery(QUERY_ACTION_DAYS_DURATION, ...)` 改为 `nativeReport(REPORT_MODE_SINGLE, REPORT_TYPE_RANGE, "$start|$end", REPORT_FORMAT_MARKDOWN, null)`
* 扩展 Data Query CLI：
  * `query data activity-suggest --lookback-days <N> --top <K> [--score-mode frequency|duration] [--activity-prefix <prefix>]`
  * `query data tree --period <day|week|month|year|recent|range> --period-arg <arg> [--level <n>]`
  * `query data days-stats --period <day|week|month|year|recent|range> --period-arg <arg> [--top <k>]`，支持通过日期/周期参数指定统计时间窗口
  * `recent` 支持 `--period-arg` 指定回溯天数（默认 7），兼容 `--lookback-days`
  * `sqlite_data_query_service` 新增周期参数解析与日期窗口归一化（ISO week/month/year/range）
* 扩展 Android query action 映射：
  * `native_bridge.cpp` 新增 `query_action=6 -> kActivitySuggest` / `query_action=7 -> kTree`
  * `NativeBridge.kt` 新增 `QUERY_ACTION_ACTIVITY_SUGGEST = 6`
* 扩展 Android JNI `nativeQuery` 参数：增加 `tree_period` / `tree_period_argument` / `tree_max_depth` 透传到 `DataQueryRequest`
* 扩展 Android contract/runtime 复用 data query：
  * **RuntimeGateway** 新增 `queryDayDurations` / `queryDayDurationStats` / `queryProjectTree`
  * **NativeRuntimeController** 新增统一 `runDataQuery(...)` 内部通路
* 扩展 Android Report **QueryReportViewModel** / **QueryReportScreen** / **TracerScreen**：
  * 新增分析参数输入（period 下拉、periodArg、level）与独立结果卡片
* 保持命令职责分离：原 `tree` 命令继续用于静态项目结构查询；周期化树统计统一走 `query data tree`

### 修复 (Fixed)

* 修复重复 ingest 同一日期时的主键冲突：
  * `statement.cpp` `day` 表写入由单纯 `INSERT` 调整为 `ON CONFLICT(date) DO UPDATE`（幂等）
  * 现在支持在同一数据库中连续执行 `Ingest Smoke` 与 `Ingest Full`
* 修复 Android 与 Windows CLI 在 `month/week/year/recent(range)` 报告格式链路的潜在分叉风险，统一为同一 core 输出路径
* 修复 Android 静态注册器手工展开导致的可维护性风险，改为表驱动后新增格式/报表类型时改动面显著降低
* 修复 `query data search --project ...` 的 SQL `ESCAPE` 子句转义写法：
  * 旧行为可能导致 SQL 执行失败并表现为 `Total: 0`；修复后可正确返回匹配日期
* 修复 data query 底层执行阶段错误被吞掉的问题：
  * `QueryStringColumn` / `QueryYearMonth` / `QueryRowsWithTotalDuration` 新增 `sqlite3_step` 终态检查
  * 非 `SQLITE_DONE` 时抛出 `Failed to execute query: <sqlite message>`，提升可诊断性

### 弃用/删除 (Deprecated/Removed)

* 删除临时兼容实现 `static_markdown_report_dto_formatter.hpp` / `static_markdown_report_dto_formatter.cpp`
