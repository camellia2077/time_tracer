## v0.4.2.0 - 2026-01-16

### 核心架构重构 (Architecture Refactoring)

本次更新的核心目标是**单一职责 (Single Responsibility)** 和 **数据流解耦**。

* **Serializer 模块独立**:
* 从 `Converter` 和 `Importer` 中剥离了所有 JSON 相关的处理逻辑。
* 新增顶级模块 `src/serializer`，包含 `LogSerializer` (Struct -> JSON) 和 `LogDeserializer` (JSON -> Struct)。
* 实现了 `Core` 层对数据格式转换的直接控制，不再依赖具体的业务模块。


* **Validator 模块独立**:
* 将分散在 `Converter` 中的验证逻辑提取为顶级模块 `src/validator`。
* 区分了 **源文件验证 (Source Validator)** 和 **输出逻辑验证 (Output Validator)**。
* `Converter` 模块现在变得纯粹，只负责 "Text -> Struct" 的转换，不再承担裁判员的角色。


* **Converter 模块纯化**:
* 移除了 `JsonWriter`，Converter 不再负责文件输出。
* 现在专注于将原始文本解析为内存中的 `DailyLog` 结构体。



### 新增 "Blink" 瞬时流水线 (New Pipeline Mode)

引入了全新的全内存处理流程，确保“零垃圾数据落盘”。

* **命令**: `blink` (别名 `run-pipeline`)
* **工作流**:
1. **Validate Source (Memory)**: 校验文本格式，失败即终止。
2. **Convert (Memory)**: 解析文本为结构体。
3. **Serialize (Memory)**: 结构体转 JSON 对象。
4. **Validate Logic (Memory)**: 校验业务逻辑（如睡眠时间连续性、活动数量），失败即终止。
5. **Persistence**: 只有上述步骤**全部成功**，才会执行：
* (Optional) 将 JSON 写入磁盘。
* (Core -> Importer) 将结构体直接注入数据库，无需二次IO。




* **优势**: 彻底避免了因逻辑错误产生的“脏” JSON 文件或数据库记录，节省IO资源。

### 模块与功能改进 (Improvements)

* **CLI (命令行工具)**:
* 修复了 `run-pipeline` 与 `blink` 命令的别名冲突问题。
* 修复了 `export` 命令中 `all-day` 拼写错误导致无法识别的问题 (修正为 `all-daily`)。
* `validate-source` 命令现在执行全链路内存验证（Dry Run），不生成任何文件。


* **Validator (验证器)**:
* 优化 `StructureRules`: 允许文件中出现多次相同的年份头（例如多个 `y2025` 块），只要年份不倒退即可，提高了对分块记录习惯的兼容性。
* 解决了验证器在内存模式下错误报告“找不到 .txt 文件”的日志问题。


* **Importer (导入器)**:
* 支持**内存直连模式** (`import_from_memory`)：直接接收 `vector<DailyLog>` 进行入库，不再强制依赖磁盘上的 JSON 文件。
* 保留了独立 `import` 命令，用于从现有 JSON 文件恢复数据。



### Bug 修复 (Bug Fixes)

* 修正了 `cli/commands/pipeline/Convert.cpp` 中未开启源文件验证导致可能生成错误数据的问题。



## v0.4.2.1 - 2026-01-17

### 🏗️ 重构 (Refactor)

* **架构分层与目录重组**：
* 将 CLI 模块明确拆分为 **`framework`** (通用框架层) 和 **`impl`** (业务实现层)。
* `framework` 包含核心机制（Parser, Registry, Command Interface, IO），不再包含任何具体业务逻辑。
* `impl` 包含具体命令实现（`ingest`, `export` 等）及应用程序生命周期管理。

* **核心组件解耦 (Dependency Breaking)**：
* **CommandRegistry 模板化**：将 `CommandRegistry` 重构为 `CommandRegistry<ContextT>` 模板类，彻底切断了框架层对业务层 `AppContext` 的依赖，实现了依赖倒置。
* **上下文隔离**：`framework` 仅依赖轻量级接口或模板参数，不再引用 `cli/impl` 下的任何头文件。


* **命名规范统一 (Google C++ Style)**：
* **文件名**：全量迁移至 **snake_case**（如 `Command.hpp` -> `i_command.hpp`, `Controller.cpp` -> `cli_application.cpp`），解决了跨平台大小写敏感问题。
* **类名与方法**：统一使用 **PascalCase**（如 `CommandRegistry::RegisterCommand`），与文件名风格形成清晰的视觉区分。
* **接口明确**：将命令基类重命名为 `ICommand`，明确其接口属性。


## v0.4.2.2 - 2026-01-17

### 修复与构建优化 (Fixes & Build)

* **修复 PCH 引入导致的符号冲突**：解决了更新预编译头（`pch.hpp`）后，因全局可见性扩大而暴露的类/结构体命名冲突问题。
* **命名空间隔离**：将 `PeriodMdConfig`、`PeriodTexConfig`、`PeriodTypConfig` 及其对应的 Formatter 类移入 `reporting` 命名空间，避免与 `ReportConfigModels.hpp` 中的同名数据结构发生重定义冲突。
* **消除重名歧义**：将 `ConverterConfig` 中的 `DurationRule` 结构体重命名为 `DurationMappingRule`，解决了与 Validator 模块中 `DurationRule` 类的命名冲突。


* **修复链接与 ODR 违规**：移除了 `ProjectResolver.cpp` 中本地静态定义的 `split_string` 函数，统一使用 `common/utils/StringUtils.hpp` 中的共享实现，解决了与 PCH 中全局声明的符号冲突。
* **头文件规范**：为 `ProjectResolver.hpp` 补充了缺失的 Include Guard。


## v0.4.2.3 - 2026-01-18


### Refactor (重构)
* **Global Naming Standardization**: 全面执行 **Google C++ Style** 命名规范，将所有核心模块（`core`, `converter`, `importer`, `bootstrap`）的源文件与头文件由 PascalCase（大驼峰）重命名为 **snake_case**（小写下划线）。
    * *目的*: 提升跨平台兼容性（Linux/Windows 文件名大小写敏感性差异），统一工程风格。
    * *示例*: `ReportHandler.hpp` → `report_handler.hpp`, `DBManager.cpp` → `db_manager.cpp`.
* **Dependency Updates**: 全量更新了项目中的 `#include` 引用路径及 Include Guards，确保与新的文件系统结构一致。
* **Build System**: 同步更新了 `CMakeLists.txt` 中的源文件列表，适配重命名后的文件路径。





## v0.4.2.4 - 2026-01-19

### 更新日志：Converter 架构解耦与配置重构

本次更新主要集中在 **Converter（转换器）模块的架构解耦** 与 **配置加载机制的重构**，旨在实现业务逻辑与配置格式的完全分离，并修复了重构过程中的路径依赖问题。

### Refactor (重构)

* **配置数据化 (Pure Data Model)**
* **变更**：将原有的 `ConverterConfig` 类（包含 Getter/Setter 和逻辑）替换为纯数据结构体 (`struct`)。
* **位置**：新模型定义在 `common/config/models/converter_config_models.hpp` 中，仅包含 `text_mapping`、`duration_mappings` 等公开成员变量。
* **收益**：`converter` 模块不再依赖具体的配置文件格式（如 TOML），仅依赖标准的 C++ 数据结构。


* **职责分离 (Separation of Concerns)**
* **Config 层**：新增 `TomlConverterConfigLoader`，专门负责读取 TOML 文件、处理配置合并以及将数据填充到 Struct 中。
* **Core 层**：负责流程编排。`PipelineManager` 通过工厂调用 Loader 获取配置对象，然后将其注入到 Converter 中。
* **Converter 层**：完全移除了文件读取和 TOML 解析代码。所有组件（如 `TextValidator`）现在通过构造函数接收准备好的 `ConverterConfig` 结构体。



### Fix (修复)

* **头文件引用路径修正 (Include Path Corrections)**
* **问题**：由于 `ConverterConfig` 从 `converter/config/` 移动到了 `common/config/models/`，导致部分依赖该配置的模块出现 "No such file or directory" 编译错误。
* **修正**：更新了以下文件中的 `#include` 路径，指向新的 `common/config/models/converter_config_models.hpp`：
* `validator/txt/facade/TextValidator.hpp`
* `validator/txt/rules/LineRules.hpp`
* `config/loader/toml_converter_config_loader.hpp`



## v0.4.2.5 - 2026-01-19

#### 1. 帮助系统重构 (CLI Documentation Refactoring)

* **单一真理源 (Single Source of Truth)**:
* 废弃了分散且硬编码的 `HelpFormatter` 打印逻辑。
* 在 `ICommand` 接口中新增 `get_help()` 方法，并在所有具体命令类（`Ingest`, `Convert` 等）中实现了自我描述。
* 现在，命令的**参数定义** (`get_definitions`) 与 **帮助描述** (`get_help`) 均在命令类内部闭环，修改代码逻辑时文档自动同步。


* **动态帮助生成**:
* 重构 `HelpFormatter` 为通用渲染引擎，根据 `CommandRegistry` 中的命令实例动态生成格式统一的 Usage 文档。


* **入口逻辑简化**:
* 优化 `main_cli.cpp`，移除对 `print_full_usage` 的直接调用。统一将无参调用转换为 `--help` 参数，全权委托给 `CliApplication` 处理，实现了帮助系统与业务逻辑的统一分发。



#### 2. 框架演进与代码质量 (Framework Evolution & Code Quality)

* **修复框架层抽象泄漏 (Fix Framework Abstraction Leak)**:
* 重构 `CommandParser`，彻底移除了内部对特定业务参数（如 `--db`, `--date-check`）的硬编码检查。
* 引入 `ParserConfig` 配置结构，支持由应用层（`CliApplication`）注入全局参数过滤规则，实现了框架核心与业务逻辑的控制反转 (IoC)。


* **统一命令执行范式 (Standardize Command Execution)**:
* 全线实装 `CommandValidator`：所有命令现在强制通过统一的验证器获取参数。
* 消除手动解析坏味道：移除了 `execute` 方法中不安全的索引访问和手动字符串匹配，改为使用 `ParsedArgs` 对象安全获取参数。

#### 3. 架构重构 (Architecture Refactoring)

* **引入服务接口层 (Dependency Inversion)**:
* 新增 `IWorkflowHandler` 和 `IReportHandler` 纯虚接口。
* `CLI` 模块的所有 Command 类现在只依赖接口引用，不再依赖 `Core` 模块的具体实现类，显著降低了模块间耦合。


* **语义对齐与重命名**:
* 类名统一：`RunPipelineCommand` -> `IngestCommand`。
* 方法统一：`WorkflowHandler::run_full_pipeline_and_import` -> `run_ingest`。



### 为什么要追求“高内聚” (Why High Cohesion?)

在本次更新中，我们将帮助文档的描述从外部的工具类 (`HelpFormatter`) 移回到了每个具体的命令类 (`IngestCommand` 等) 内部，这是对 **“高内聚 (High Cohesion)”** 原则的典型实践。

#### 2. 本次重构带来的具体优势：

* **维护原子性 (Atomic Maintenance)**
* **以前（低内聚）**：当你修改 `IngestCommand` 增加一个 `--verbose` 参数时，你必须记得到 `HelpFormatter.cpp` 去修改打印字符串。**逻辑**在 A 处，**文档**在 B 处。开发者经常忘记修改 B，导致文档腐烂（Document Rot）。
* **现在（高内聚）**：`IngestCommand` 包含了关于“摄入”这一行为的所有信息：它怎么跑 (`execute`)、它需要什么参数 (`get_definitions`)、它是干什么的 (`get_help`)。修改逻辑时，你在同一个文件中就能更新文档，保证了修改的原子性。


* **降低认知负荷 (Reduced Cognitive Load)**
* 开发者阅读代码时，不需要在多个文件间反复跳转来理解一个命令的完整面貌。`Command` 类成为了自包含的单元，阅读该文件即可掌握该命令的所有细节。


* **符合开闭原则 (Open/Closed Principle)**
* **以前**：每新增一个命令，必须去修改 `HelpFormatter` 的 `print_full_usage` 函数（修改现有代码）。
* **现在**：新增命令只需编写新的 Command 类并注册。`HelpFormatter` 变成了通用的渲染器，无需修改任何现有代码即可自动支持新命令。

### 修复与优化 (Fixes & Improvements)

* **编译错误修复**:
* 修复了 `IngestCommand` 中试图访问不存在的配置项 `save_processed_output` 导致的编译失败。
* 改为在 Command 内部默认开启保存 (`true`)，并支持通过 `--no-save` 参数进行覆盖，不再强依赖配置文件中的字段。
* **[新增] 修复链接错误**: 补全了 `ParsedArgs` 类的实现文件 (`arg_definitions.cpp`) 并将其加入构建系统，解决了 `undefined reference` 问题。


* **依赖管理优化**:
* `AppContext` 改为持有接口指针，由 `CliApplication` 负责具体类的生命周期管理和依赖注入。













