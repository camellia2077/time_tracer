## [v0.5.6] - 2026-02-07
### Summary
优化 CLI 用户体验，简化帮助信息并分类命令；引入细粒度报错状态码（AppExitCode）与自定义异常体系，增强 CLI 鲁棒性与自动化测试反馈；通过大规模重构 reports 模块及 Parser 目录扁平化，实现逻辑解耦与架构精简；补齐 `month` 报表插件接入并清理冗余 Facade/死代码，稳定构建流程。

## Breaking Changes
* **数据查询语法规范化**：`query-data` 命令移除旧的 Flag 模式（`--years`/`--months`/`--days`），强制使用位置参数（`query-data years` 等）。这确保了 CLI 语法的一致性。
* **搜索语法严格化**：某些隐式搜索语法（如 `query-data --filters`）不再支持，必须显式指定 `search` 动作（如 `query-data search --filters`）。
* **命令合并**：`query-data` 已合并入 `query` 命令。新语法为 `query data <action>`（例如 `query data years`）。旧的 `query-data` 命令已被移除。

## Changed/Refactor
* **Clean Architecture 目录重构**：为了提升代码的可扩展性与职责清晰度，完成了全项目的目录分层重构：
    - **API 层** (`src/api/`): 将原 `cli/` 目录移入，明确对外接口边界。
    - **Domain 层** (`src/domain/logic/`): 整合原 `validator/` 与 `converter/` 逻辑，核心业务逻辑更加聚合。
    - **Application 层** (`src/application/`): 建立应用层，整合 `importer/`、`bootstrap/`（原 `src/application/bootstrap`）及 `adapters/`。
    - **Infrastructure 层** (`src/infrastructure/`): 整合 `serialization/`（原 `serializer/`）与 `config/`，统管底层技术细节。
    - **Shared 层** (`src/shared/`): 建立共享层，收纳跨层使用的 `utils`（原 `common/utils`）及核心类型定义。
* **配置模型扁平化与规范化**：
    - 解决了 `infrastructure/config/models` 内部深层嵌套导致的引用混乱问题，实现路径扁平化。
    - 完成全项目 150+ 个源文件的 `#include` 路径同步修正，确保构建系统（CMake）与物理结构完全匹配。
* **Parser 目录扁平化与减负**：
    - 废弃了 `application/adapters/input/parser` 和 `application/importer/parser/details` 等过深且单薄的嵌套层级。
    - 将 `TextParser`、`DayParser`、`ActivityParser` 及 `MemoryParser` 统一收敛至 `src/application/parser/`，降低了代码导航成本，避免了过度工程。
* **ConverterService 职责重定位**：
    - 将 `ConverterService` 从 Domain 层迁移至 Application 层 (`src/application/service/`)。
    - 明确了其作为“流程编配者”的服务角色，使其符合标准的应用服务（Application Service）架构。
* **Reports 模块彻底收敛**：
    - 完成 `reports/` 目录的拆解与迁移，将报表模型（Domain）、服务（Application）与格式化实现（Infrastructure）彻底解耦并归位。
* **PCH 稳定性增强**：更新了 `pch.hpp` 以适配调整后的物理路径，解决了因目录大规模移动导致的预编译头缓存同步冲突。
* **CMake 基础设施现代化**：
    - **递归扫描 (Recursive Globbing)**：在 `AddFormatTarget.cmake` 和 `AddTidyFixTarget.cmake` 中引入递归文件扫描，取代了脆弱的手动源文件列表。这确保了所有新增加的架构层级（api, domain, infrastructure 等）都能被自动纳入格式化与静态检查范围。
    - **目标配置优化**：重构了 `TargetSetup.cmake`，统一了 `src/` 包含根路径，并精简了 C++23 链接标志（如 `stdc++exp`）。
    - **部署增强**：改进了 `Win32PostBuildCopy.cmake` 的 DLL 拷贝逻辑，提升了在不同 MinGW/Clang 环境下的部署鲁棒性。
    - **修复 Format 指令**：彻底修复了因目录结构拆分导致 `ninja format` 指令引用失效的问题。
* **验证逻辑性能优化**: 将 `LogicValidatorStep` 重构为直接使用 C++ 原生结构体 (`DailyLog`, `TimeRecordInternal`) 进行业务规则校验，替代了原先“Struct -> JSON -> Validation”的低效流程。此举避免了巨大的中间序列化/反序列化开销，显著提升了处理流水线的性能与类型安全性。
* **Facade 模式清理**：移除了 `infrastructure` 层中冗余的 `ConfigFacade` 和 `ConverterFacade`，清理了空的 Facade 目录。这些代码仅作为纯粹的转发层，无实际业务逻辑，移除后减少了不必要的间接调用，简化了系统架构。
* **`month` 报表插件接入**：在 `time_tracer_cpp/apps/time_tracer/CMakeLists.txt` 增加 `month` 插件子目录，并在 `time_tracer_cpp/apps/time_tracer/cmake/Packaging.cmake` 中加入 `MonthMdFormatter`/`MonthTypFormatter`/`MonthTexFormatter`。
* **报表格式注册调整**：在 `src/infrastructure/reports/formatter_registry.cpp` 为 `MonthlyReportData` 绑定 `Month*Formatter`，避免复用 `Range*Formatter`。
* **启动校验扩展**：在 `src/application/bootstrap/startup_validator.cpp` 增加 `Month*Formatter` 插件校验，保证运行环境一致性。
* **`month` 插件实现对齐数据模型**：`month_*_formatter.cpp` 与 `month_tex_utils.cpp` 统一使用 `range_label`/`is_valid`，移除对 `year_month`/`year`/`month` 的依赖。
* **`month` 插件 CMake 修正**：修复 `month_md_config.cpp`/`month_typ_config.cpp` 在 `CMakeLists.txt` 中的文件名大小写不一致问题。
* **细粒度错误处理体系集成**：
    - 更新 `CliApplication::Execute` 以捕获特定的 `AppError`（如 `DatabaseError`, `IoError`）并返回对应的 `AppExitCode`。
    - 增强 Python 测试引擎，在检测到退出码不匹配时，自动映射退出码为直观的错误描述（如 `2` -> `Unknown Command`），提升调试效率。
## Added
* **PeriodParser**: 位于 `src/cli/impl/utils/period_utils.hpp`，提供全项目统一的周期参数解析与标准化接口。
* **细粒度报错退出码 (AppExitCode)**: 位于 `src/shared/types/exit_codes.hpp`，定义了包括 `kDatabaseError`、`kConfigError`、`kIoError` 等在内的 10 种标准退出状态，取代了单一的 `0/1` 模式。
* **自定义异常体系 (Exceptions)**: 位于 `src/shared/types/exceptions.hpp`，建立以 `AppError` 为基类的结构化异常模型，支持跨层传递具体的错误上下文。
* **大型文件检测工具**: 新增 `find.py` 脚本，用于递归扫描项目源目录并报告超过行数阈值的 C++ 源文件。

## Fixed
* **编译恢复**: 修复了重构过程中因头文件引用缺失导致的 `query_command.cpp` 编译失败问题。
* **`month` Typst 配置读取**：修复 `month_typ_config.cpp` 中 `value_or` 模板匹配失败导致的编译错误。
* **`month` LaTeX 工具函数命名**：修复 `month_tex_utils` 的 `DisplayHeader` 声明与调用不一致问题。
* **构建清单同步**：移除已删除 Facade 源文件在 `src/application/CMakeLists.txt` 与 `src/infrastructure/CMakeLists.txt` 的引用，修复 CMake 配置失败。

## Deprecated/Removed
* **Facade 清理**：删除 `src/infrastructure/config/validator/reports/facade/` 中的 `QueryFacade` 以及 `src/domain/logic/validator/json/facade/` 中的 `JsonValidator`。
* **死代码删除**：移除 `src/api/cli/impl/commands/query/data_query_command.*` 与 `src/infrastructure/serialization/serializer/core/*` 的冗余实现。













