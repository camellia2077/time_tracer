# 系统设计与核心逻辑 (System Design & Core Logic)

**版本**: 0.5.0
**更新**: 2026年1月

## 1. 设计哲学

TimeTracer 专为**量化生活 (Quantified Self)** 爱好者设计，核心目标是极致的输入效率与深度的统计分析。

> **Trace your time, log your life.**

### 1.1 极简输入原则
时间是宝贵的资源。系统允许用户按“变化点”记录，由程序负责“重建上下文”。用户无需像使用 LaTeX 那样编写繁琐的标记，只需专注于记录活动本身。

### 1.2 语义分层分离
*   **日志层 (Log Layer)**: 面向人类的高速输入（例如直接写 `gym`）。
*   **领域层 (Domain Layer)**: 机器友好的标准化语义（例如 `exercise.anaerobic`）。
*   **解析适配器 (`ParserAdapter`)** 充当两者之间的翻译官，实现从随意输入到规范数据的跨越。

### 1.3 数据仓库方法
存储层 (`infrastructure/persistence`) 采用了数据仓库的设计思想。它不仅存储原始记录，还存储**预聚合指标**（如每日总睡眠、总学习时长），这使得生成复杂趋势报告时的速度极快。

---

## 2. 摄取子系统 (Ingestion Subsystem)

该系统通过 **管道模式 (Pipeline Pattern)** 将非结构化的文本流逐步转化为富含语义的领域模型。

### 2.1 上下文状态机
为了支持极简记录（无需每行都写日期），解析器维护了状态机：
*   **年份锚点 (Year Anchor)**: 由 `y2025` 类标记锁定。
*   **日期锚点 (Date Anchor)**: 由 `0101` 类标记开启。
*   所有随后的事件都会继承这些锚点属性，直到遇到新的标记。

### 2.2 领域语义漏斗
原始字符串会经过三级过滤：
1.  **别名映射 (Normalization)**: 将 `workout` 或 `举铁` 映射为 `exercise`。
2.  **时长修正 (Duration Correction)**: 若某次 `reading` < 15分钟，系统会自动重划分为 `browsing` (随便翻翻)。
3.  **路径构建 (Path Construction)**: `study_cpp` 被构建为树状路径 `study -> coding -> cpp`。

---

## 3. 存储模型 (Storage Model)

数据库基于 SQLite，采用**维度建模 (Dimensional Modeling)**。

### 3.1 实体关系
*   **`DAYS`**: 存储每日元数据及预聚合生成的统计指标（Study, Sleep, etc.）。
*   **`PROJECTS`**: 采用邻接表实现的自引用表，保证了分类体系的动态增长。
*   **`TIME_RECORDS`**: 事实表，存储每一项具体的原子活动及关联路径。

### 3.2 动态分类树 (Dynamic Taxonomy)
系统不需要用户预设分类字典。分类树是在数据摄取过程中**动态生长**的。当系统解析到新路径时会自动创建对应的节点。这允许用户的分类体系随着生活习惯的改变而随时演化，无需手动迁移数据库。

---

## 4. 运行安全与校验

### 4.1 递进式验证
1.  **结构验证 (Steps层)**: 检查 TXT 的块对齐、年份头及基本语法。
2.  **逻辑验证 (Domain层)**: 检测“时间旅行”（非单调递增的时间戳）及由于记录疏忽导致的睡眠断层。

### 4.2 快速失败原则 (Fail-Fast)
`PipelineManager` 在遇到任何验证错误时会立即中止流程。这确保了只有高质量、逻辑自洽的数据才能进入持久化层，从源头上保证了统计报表的准确性。
