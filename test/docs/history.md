# 测试脚本架构重构总结 (2026-01-17)

## 1. 核心架构变更：从“过程式”转向“面向对象/组件化”

新版代码对原有架构进行了彻底的重构，将单一的大型类拆分为多个职责单一的组件，符合 **单一职责原则 (SRP)**。

* **核心引擎化 (`TestEngine`)**：引入 `TestEngine` 类作为大脑，负责协调环境准备、测试执行和结果汇总，使 `main.py` 变得极其简洁。
* **上下文对象 (`TestContext`)**：引入 `TestContext` 模式，将运行时动态生成的路径（如临时目录、数据库位置）封装在一起，统一传递给各个 Tester，解决了之前路径参数过长且难以维护的问题。
* **解耦执行逻辑**：
* **`CommandExecutor`**：专门负责底层 `subprocess` 调用。
* **`TestLogger`**：专门负责日志文件写入和控制台着色输出。
* **`BaseTester`**：现在仅负责逻辑组装，通过调用 Executor 和 Logger 完成测试。



## 2. 环境管理增强：引入纯净测试模式

为了保证测试的可靠性，新增了对测试环境的精细控制：

* **临时目录支持 (`Workspace`)**：通过 `tempfile.TemporaryDirectory` 支持创建随机的临时文件夹进行测试。如果在 `config.toml` 中开启，每次测试都会在一个完全“纯净”的环境中运行，并在测试结束自动销毁，防止历史数据污染。
* **组件化部署 (`ArtifactDeployer`)**：将文件复制逻辑独立出来。现在可以根据配置同时支持文件和整个文件夹（如 `config/`, `plugins/`）的同步。
* **灵活的运行控制**：在 `[run_control]` 中细化了开关，可以单独控制“清理环境”、“准备环境”和“执行测试”三个阶段。

## 3. 配置系统升级：强类型与数据类

放弃了传统的字典/元组传递配置，改用 Python `dataclasses`：

* **强类型配置 (`definitions.py`)**：所有配置项（Paths, TestParams, Cleanup 等）均有明确定义的字段和默认值，不仅提供了代码补全，还增强了运行时校验。
* **统一加载器 (`loader.py`)**：`load_config` 函数现在返回一个嵌套的 `GlobalConfig` 对象。它增加了更智能的路径推导逻辑（例如根据 `test_data_path` 自动计算 `PROCESSED_JSON_PATH`）。

## 4. 具体的业务逻辑优化

* **测试用例工厂 (`registry.py`)**：引入注册机制。现在增加或删除测试模块只需在 `create_test_suite` 函数中操作，无需修改 Engine 核心逻辑。
* **`ExportTester` 改进**：
* **独立数据库参数**：显式支持通过 `--database` 指定数据库路径，不再依赖 EXE 的相对路径。
* **路径隔离**：支持将导出结果定向到特定的 `export_output_dir`。


* **`QueryTester` 改进**：增加了对数据库文件存在性的前置检查，并统一了查询命令的参数构建逻辑。
* **日志系统精简化**：控制台输出现在更加直观，对于成功执行的命令，支持只回显前 5 行输出片段，避免屏幕被大量内容刷屏。

## 5. 项目结构对比

| 模块 | 旧版实现 | 新版实现 |
| --- | --- | --- |
| **入口** | `test_exe_main.py` (逻辑较重) | `main.py` (极简，仅加载配置并启动 Engine) |
| **测试基类** | 包含执行、日志、逻辑 | 仅包含逻辑协调，执行与日志已分离 |
| **路径管理** | 基于字符串拼接 | 基于 `Path` 对象与 `TestContext` 上下文 |
| **环境清理** | 简单的 `shutil.rmtree` | 支持 `TemporaryDirectory` 自动管理 |
| **配置访问** | `config.Paths.XXX` | `config.paths.XXX` (强类型 DataClass) |
